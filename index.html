<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supermarket Experiment</title>






<style>
/* -----------------------------------------------------------
   GENERAL
----------------------------------------------------------- */
body {
    margin: 0;
    font-family: 'Inter', Arial, sans-serif;
    background: #f4f4f5;
    padding-top: 80px;
    display: flex;
    justify-content: center;
}

/* -----------------------------------------------------------
   HEADER
----------------------------------------------------------- */
#header {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 70px;
    background: #ffffff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.10);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 40px;
    z-index: 1000;
}

#header h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    color: #222;
    letter-spacing: -0.5px;
}

#cartButton {
    background: #111;
    color: #fff;
    padding: 10px 20px;
    border-radius: 16px;
    font-weight: 600;
    display: flex; align-items: center; gap: 8px;
    cursor: pointer;
    transition: 0.25s;
}

#cartButton:hover {
    background: #333;
}

/* -----------------------------------------------------------
   PRODUCT GRID
----------------------------------------------------------- */
#shelf {
    width: 90%;
    max-width: 1300px;
    background: #fff;
    padding: 20px;
    border-radius: 18px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
}


/* 5 colonne fisse sempre */
.row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
}



/* -----------------------------------------------------------
   PRODUCT CARDS
----------------------------------------------------------- */
.product {
    background: #ffffff;
    border-radius: 14px;
    padding: 8px;
    height: 210px; /* FIX */
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.15s;
}

.product:hover {
    transform: translateY(-3px);
}


.productGrid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 18px;
    width: 100%;
}


.product img {
    width: 100%;
    height: 120px;
    object-fit: contain;
    border-radius: 8px;
}



/* titolo prodotto */
.name {
    font-size: 14px;
    margin-top: 6px;
    font-weight: 600;
    color: #222;
}

.price {
    font-size: 14px;
    color: #0a9d2a;
    font-weight: bold;
    margin-top: 3px;
}


/* -----------------------------------------------------------
   CART PAGE
----------------------------------------------------------- */
#cartPage {
    display: none;
    background: #ffffff;
    padding: 35px 40px;
    border-radius: 22px;
    width: 90%; max-width: 900px;
    box-shadow: 0px 5px 18px rgba(0,0,0,0.1);
    animation: fadeIn 0.4s ease-in-out;
}

#cartPage h2 {
    font-size: 26px;
    font-weight: 600;
    margin-bottom: 15px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 8px;
}

#cartList li {
    padding: 8px 0;
    font-size: 16px;
    border-bottom: 1px solid #eee;
}

/* -----------------------------------------------------------
   BUTTONS
----------------------------------------------------------- */
button {
    padding: 14px 24px;
    border-radius: 14px;
    font-size: 17px;
    font-weight: 600;
    cursor: pointer;
    border: none;
}

#downloadBtn {
    background: #1A7A1A;
    color: white;
}
#downloadBtn:hover { background: #145c14; }

#backBtn {
    background: #ddd;
}
#backBtn:hover { background: #ccc; }

/* -----------------------------------------------------------
   ANIMATION
----------------------------------------------------------- */
@keyframes fadeIn {
    from {opacity: 0; transform: translateY(10px);}
    to   {opacity: 1; transform: translateY(0);}
}



/* ðŸ“Œ RESPONSIVE LAYOUT */

/* ðŸ”µ Tablet (max-width: 1024px) */
@media (max-width: 1024px) {
    body {
        padding-top: 120px;
        zoom: 0.95;
    }

    #shelf {
        width: 95%;
        padding: 15px;
    }

    .productGrid {
        grid-template-columns: repeat(4, 1fr); /* 4 prodotti per riga */
        gap: 14px;
    }

    .product {
        height: 200px;
        padding: 8px;
    }

    .product img {
        height: 110px;
    }
}

/* ðŸŸ¢ Smartphone (max-width: 700px) */
@media (max-width: 700px) {
    body {
        padding-top: 120px;
        justify-content: flex-start;
    }

    #header {
        padding: 0 20px;
        height: 65px;
    }

    #header h2 {
        font-size: 18px;
    }

    #instructionBar {
        height: 60px;
        font-size: 13px;
        text-align: center;
        padding: 0 10px;
    }

    #cartButton, #header div {
        padding: 7px 12px;
        border-radius: 14px;
        font-size: 14px;
    }

    .productGrid {
        grid-template-columns: repeat(2, 1fr); /* 2 prodotti per riga */
        gap: 12px;
    }

    .product {
        height: 180px;
        padding: 6px;
    }

    .product img {
        height: 90px;
    }

    .name {
        font-size: 12px;
    }

    .price {
        font-size: 12px;
    }

    #cartPage {
        width: 95%;
        padding: 20px 15px;
    }

    #cartPage h2 {
        font-size: 20px;
    }

    button {
        width: 100%;
        margin-top: 10px;
        font-size: 16px;
        padding: 12px 0;
    }

    #toast {
        right: 15px;
        top: 90px;
        font-size: 13px;
        padding: 10px 14px;
    }
}

/* ðŸ”´ Mobile piccolo (max-width: 400px) */
@media (max-width: 400px) {
    .productGrid {
        grid-template-columns: 1fr; /* 1 prodotto per riga */
    }

    #header h2 {
        font-size: 16px;
    }

    #instructionBar {
        font-size: 12px;
    }
}



@media (max-width: 700px) {
    .intro-modal,
    .start-modal,
    .thank-you-modal {
        width: 80%;
        max-width: 380px;
        padding: 28px 22px;
    }

    .intro-logo {
        height: 80px;
    }
}




@media (max-width: 700px) {
    body {
        padding-top: 20px;          /* meno spazio perchÃ© lâ€™header non Ã¨ piÃ¹ fixed */
    }

    #header {
        position: static;           /* NON piÃ¹ fixed su mobile */
        width: 100%;
        height: auto;
        padding: 12px 16px;
        flex-direction: column;     /* titolo sopra, cart sotto */
        align-items: flex-start;
        gap: 8px;
    }

    #header h2 {
        font-size: 20px;
    }

    #headerInstruction {
        font-size: 12px;
    }

    .header-right {
        align-self: stretch;
        justify-content: space-between;
    }
}


@media (max-width: 700px) {
    #categoryBar {
        padding: 10px 12px;
        justify-content: center;
    }

    .catTab {
        width: 80%;
        max-width: 360px;
        text-align: center;
        font-size: 14px;
    }
}

</style>


<meta name="viewport" content="width=device-width, initial-scale=1.0">








</head>








<body>

<div id="header">
    <h2>Supermarket Experiment</h2>
    <div onclick="openCart()" style="cursor:pointer; background:black; color:white; padding:10px 18px; margin-right:60px; border-radius:20px;">
        ðŸ›’ <span id="cartCount">0</span>
    </div>
</div>







<div id="introScreen" style="
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(135deg, #f2f4f7 0%, #ffffff 100%);
    display: flex; justify-content: center; align-items: center;
    z-index: 2000; font-family: 'Arial', sans-serif;
">
    <div style="
        background: white;
        width: 420px;
        padding: 35px 40px;
        border-radius: 20px;
        box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        text-align: center;
        animation: fadeIn 0.5s ease-in-out;
    ">
        <h2 style="margin-bottom: 10px; color:#004aad; font-size: 26px;">
            Supermarket Experiment
        </h2>

        <p style="color:#444; font-size:15px; margin-bottom:25px;">
            You will simulate a grocery shopping session. Select the products you would normally buy by clicking on them. When finished, open the basket (top right) and click <b>Finish Shopping</b>. Act as naturally as possible, as if you were in a real supermarket.
        </p>

        <button onclick="showParticipantForm()" style="
            width: 100%;
            padding: 14px 0;
            font-size: 18px;
            background: #004aad;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.25s;
        "
        onmouseover="this.style.background='#00337a'"
        onmouseleave="this.style.background='#004aad'">
            Start
        </button>
    </div>
</div>










<div id="startScreen" style="
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(135deg, #f2f4f7 0%, #ffffff 100%);
    display: none; justify-content: center; align-items: center;
    z-index: 2000; font-family: 'Arial', sans-serif;
">
    <div style="
        background: white;
        width: 420px;
        padding: 35px 40px;
        border-radius: 20px;
        box-shadow: 0 6px 25px rgba(0,0,0,0.15);
        text-align: center;
        animation: fadeIn 0.5s ease-in-out;
    ">
    
        <h2 style="margin-bottom: 10px; color:#004aad; font-size: 26px;">
			Partecipant information
		</h2>

        <p style="color:#666; margin-bottom: 25px; font-size: 15px;">
            Please fill in the information below to begin the experiment.
        </p>

        <div style="text-align:left;">

            <label class="label">Age</label>
            <input id="ageInput" type="number" min="10" max="100" class="input">

            <label class="label">Gender</label>
            <select id="genderInput" class="input">
                <option value="">Select...</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
            </select>

     
            <label class="label">Nationality</label>
			<select id="nationInput" class="input">
				<option value="">Select country...</option>
				<option value="Italy">Italy</option>
				<option value="France">France</option>
				<option value="Spain">Spain</option>
				<option value="Germany">Germany</option>
				<option value="Portugal">Portugal</option>
				<option value="Netherlands">Netherlands</option>
				<option value="Belgium">Belgium</option>
				<option value="Sweden">Sweden</option>
				<option value="Norway">Norway</option>
				<option value="Denmark">Denmark</option>
				<option value="Finland">Finland</option>
				<option value="Austria">Austria</option>
				<option value="Switzerland">Switzerland</option>
				<option value="Poland">Poland</option>
				<option value="Czech Republic">Czech Republic</option>
				<option value="Slovakia">Slovakia</option>
				<option value="Greece">Greece</option>
				<option value="Ireland">Ireland</option>
				<option value="Romania">Romania</option>
				<option value="Bulgaria">Bulgaria</option>
				<option value="Hungary">Hungary</option>
			</select>


            <label class="label">Online Shopping Frequency</label>
            <select id="onlineInput" class="input">
                <option value="Never">Never</option>
                <option value="Rarely">Rarely</option>
                <option value="Sometimes">Sometimes</option>
                <option value="Often">Often</option>
            </select>

            <label class="label">Weekly Grocery Shopping</label>
            <select id="freqInput" class="input">
                <option value="1-2">1â€“2 times</option>
                <option value="3-4">3â€“4 times</option>
                <option value="5+">5 or more</option>
            </select>

        </div>

		<button onclick="startExperiment()" style="
				width: 100%;
				margin-top: 20px;
				padding: 14px 0;
				font-size: 18px;
				background: #00b33c;
				color: white;
				border: none;
				border-radius: 12px;
				cursor: pointer;
				transition: 0.25s;
			"
			onmouseover="this.style.background='#009933'"
			onmouseleave="this.style.background='#00b33c'">
			Start the Experiment
		</button>

    </div>
</div>

<style>
    .label {
        display:block;
        margin-bottom:6px;
        margin-top:12px;
        font-size:14px;
        font-weight:bold;
        color:#555;
    }
    .input {
        width:100%;
        padding:10px;
        border:1px solid #ccc;
        border-radius:10px;
        font-size:15px;
        outline:none;
        background:#f9f9f9;
        transition:0.2s;
        margin-bottom:5px;
    }
    .input:focus {
        border-color:#888;
        background:white;
        box-shadow:0 0 5px rgba(0,0,0,0.1);
    }
    @keyframes fadeIn {
        from {opacity:0; transform:translateY(10px);}
        to   {opacity:1; transform:translateY(0);}
    }
</style>

















<div id="shelf"><h3>Loading products...</h3></div>

<div id="cartPage">
    <h2 style="color:#004aad;">Selected products</h2>
    <div id="cartList"></div>
    <button id="downloadBtn" onclick="downloadCSV()">Download CSV</button>
    <button id="backBtn" onclick="closeCart()">Back</button>
</div>




<div id="toast">Added to cart</div>

<style>
#toast {
    position: fixed;
    top: 90px;
    right: 30px;
    background: #111;
    color: white;
    padding: 12px 18px;
    border-radius: 12px;
    font-size: 15px;
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
    transition: all 0.35s ease;
    z-index: 3000;
}
#toast.show {
    opacity: 1;
    transform: translateY(0);
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

<script>

	
// -----------------------------------------------------------------------------
// LOGGING
// -----------------------------------------------------------------------------
let experimentStart = Date.now();
let hoverLog = [];
let indecisionLog = [];
let clickLog = [];
let cart = [];
let devSimulations = [];   // Qui salveremo tutte le simulazioni create


// -----------------------------------------------------------------------------
// 70 PRODUCTS (ALL IMAGES EMPTY, YOU WILL FILL THEM)
// -----------------------------------------------------------------------------
const products = [
    // ---- Products you provided ----
	
	
	
{name:"Nutella 950g", price:4.99, category:"Sweet spreads", img:"img/Nutella_950g_Ferrero.jpg"},
{name:"Krave Cereal", price:3.49, category:"Cereal", img:"img/front_it.22.200 (1).jpg"},
{name:"Kinder Colazione PiÃ¹", price:2.99, category:"Snacks", img:"img/front_it.24.200.jpg"},
{name:"Yogurt Magro Vipiteno", price:1.20, category:"Dairy", img:"img/front_it.25.200 (1).jpg"},
{name:"Lindt 100% Cacao", price:2.99, category:"Chocolate", img:"img/front_it.28.200.jpg"},
{name:"Mulino Bianco Cioccograno", price:2.50, category:"Biscuits", img:"img/front_it.31.200.jpg"},
{name:"Unconventional Veggie Burger", price:3.90, category:"Vegan", img:"img/front_it.32.200.jpg"},
{name:"Peanut Butter Maribel 100%", price:2.49, category:"Spreads", img:"img/front_it.33.200.jpg"},
{name:"Nutella Plant Based", price:4.99, category:"Sweet spreads", img:"img/front_it.53.200 (2).jpg"},

{name:"Barilla Penne Rigate Integrali", price:1.29, category:"Pasta", img:"img/front_it.54.200 (3).jpg"},
{name:"Gran Cereale Riso & Cornflakes", price:2.49, category:"Biscuits", img:"img/front_it.54.200.jpg"},
{name:"Pan di Stelle Cookies", price:2.99, category:"Biscuits", img:"img/front_it.62.200.jpg"},
{name:"Gocciole Extra Dark", price:2.79, category:"Biscuits", img:"img/front_it.66.200 (2).jpg"},
{name:"Yogurt Intero Vipiteno", price:1.20, category:"Dairy", img:"img/front_it.42.200.jpg"},
{name:"Garden Gourmet Soy Strips", price:3.99, category:"Vegan", img:"img/front_it.43.200 (1).jpg"},
{name:"Mulino Bianco Fette Integrali", price:1.89, category:"Bakery", img:"img/front_it.53.200 (1).jpg"},
{name:"Kioene Spinach Miniburger", price:3.49, category:"Vegan", img:"img/front_it.53.200.jpg"},
{name:"Fiorentini Peanut Butter", price:2.90, category:"Spreads", img:"img/front_it.54.200 (1).jpg"},

{name:"Galbusera Buoni CosÃ¬", price:2.49, category:"Biscuits", img:"img/front_it.58.200.jpg"},
{name:"Barilla Pesto alla Genovese", price:3.49, category:"Sauce", img:"img/front_it.86.200.jpg"},
{name:"Milk Kefir Naturale", price:1.99, category:"Dairy", img:"img/front_it.89.200.jpg"},
{name:"My Best Veggie Hummus", price:1.49, category:"Vegan", img:"img/front_it.95.200 (1).jpg"},
{name:"Mulino Bianco Molinetti", price:2.49, category:"Biscuits", img:"img/front_it.100.200.jpg"},
{name:"Mulino Bianco Pan Bauletto", price:1.89, category:"Bread", img:"img/front_it.116.200.jpg"},
{name:"Arborea Semi-skimmed Milk", price:1.29, category:"Dairy", img:"img/front_it.104.200.jpg"},
{name:"Heinz Tomato Ketchup", price:2.49, category:"Sauce", img:"img/front_it.105.200.jpg"},
{name:"Coca Cola Zero Can", price:1.00, category:"Drinks", img:"img/front_it.70.200.jpg"},
{name:"Wasa Crackers Integrale", price:1.89, category:"Dry", img:"img/front_it.72.200.jpg"},

{name:"Nesquik Powder", price:3.99, category:"Sweet", img:"img/front_it.54.200 (2).jpg"},
{name:"Pan Bauletto Grano Dâ€™Oro", price:1.99, category:"Bread", img:"img/front_it.116.200.jpg"},
{name:"Gocciole Chocolate", price:2.69, category:"Biscuits", img:"img/front_it.66.200 (2).jpg"},
{name:"Kellogg All Bran", price:3.29, category:"Cereal", img:"img/front_it.136.200.jpg"},
{name:"Mutti Passata", price:1.49, category:"Sauce", img:"img/front_it.195.200.jpg"},
{name:"Alpro Mango Soy Yogurt", price:2.19, category:"Dairy-free", img:"img/Mango.jpg"},
{name:"Star Mustard", price:1.29, category:"Sauce", img:"img/Mustard.jpg"},
{name:"Barilla Spaghetti N.5", price:1.19, category:"Pasta", img:"img/Pasta.jpg"},
{name:"Rana Ricotta & Spinach Tortellini", price:2.99, category:"Fresh Pasta", img:"img/Ricotta.jpg"},
{name:"Capitan Findus 18 Fish Sticks", price:3.50, category:"Frozen", img:"img/front_it.8.200.jpg"},


{name:"Ritz Crackers Original 200g", price:2.49, category:"Snacks", img:"img/front_fr.17.200.jpg"},
{name:"Rovagnati Snello Ham 120g", price:3.29, category:"Cold cuts", img:"img/front_it.3.200 (2) - Copia.jpg"},
{name:"Cameo Vitalis Muesli No Added Sugar 300g", price:3.49, category:"Cereal", img:"img/front_it.3.200 (3).jpg"},
{name:"Mulino Bianco Abbracci Cookies 350g", price:2.99, category:"Biscuits", img:"img/front_it.3.200 (4).jpg"},
{name:"Conad Verso Natura Organic Granola with Chocolate 400g", price:2.79, category:"Cereal", img:"img/front_it.3.200 (5) - Copia.jpg"},
{name:"Conad Verso Natura Organic Spinach Veggie Burgers", price:3.49, category:"Vegan", img:"img/front_it.3.200 (6) - Copia.jpg"},
{name:"Valfrutta Cannellini Beans Jar", price:1.49, category:"Canned", img:"img/front_it.4.200.jpg"},
{name:"Gran Pavesi Crackers Low Salt", price:2.29, category:"Snacks", img:"img/front_it.9.200.jpg"},
{name:"Kellogg's Coco Pops Barchrette", price:3.99, category:"Cereal", img:"img/front_it.10.200.jpg"},
{name:"Loacker Napolitaner Wafers", price:2.19, category:"Biscuits", img:"img/front_it.44.200.jpg"},

{name:"Sottilette Classic Cheese Slices", price:2.49, category:"Dairy", img:"img/front_it.53.200 (3).jpg"},
{name:"Bauli Pandoro di Verona", price:6.99, category:"Bakery", img:"img/front_it.49.200.jpg"},
{name:"Philadelphia Original XL", price:3.49, category:"Dairy", img:"img/front_it.48.200 (1).jpg"},
{name:"NestlÃ© Fitness Original Cereal", price:3.29, category:"Cereal", img:"img/front_it.51.200.jpg"},
{name:"Lete Mineral Water 1.5L", price:0.49, category:"Drinks", img:"img/front_it.48.200.jpg"},
{name:"Doria Bucaneve Cookies", price:2.79, category:"Biscuits", img:"img/front_it.56.200.jpg"},
{name:"Mulino Bianco Galletti Cookies", price:2.29, category:"Biscuits", img:"img/front_it.86.200 (1) - Copia.jpg"},
{name:"Mikado Dark Chocolate Sticks", price:1.99, category:"Snacks", img:"img/front_it.88.200.jpg"},
{name:"Gocciole Chocolate Cookies 500g", price:2.79, category:"Biscuits", img:"img/front_it.117.200.jpg"},
{name:"Ichnusa Non Filtrata Beer", price:1.49, category:"Drinks", img:"img/front_it.122.200.jpg"},

{name:"Arla Summer Milk", price:1.49, category:"Dairy", img:"img/Arla-Standard-Milk_Iconic.jpg"},
{name:"Bananas (Bunch)", price:1.99, category:"Fruit", img:"img/Banana_Iconic.jpg"},
{name:"Granny Smith Apple", price:0.69, category:"Fruit", img:"img/Granny-Smith_Iconic.jpg"},
{name:"Green Bell Pepper", price:0.99, category:"Vegetables", img:"img/Green-Bell-Pepper_Iconic.jpg"},
{name:"Lemon", price:0.50, category:"Fruit", img:"img/Lemon_Iconic.jpg"},
{name:"Oatly Natural Oatgurt", price:2.19, category:"Dairy-free", img:"img/Oatly-Natural-Oatghurt_Iconic.jpg"},
{name:"Pink Lady Apple", price:0.79, category:"Fruit", img:"img/Pink-Lady_Iconic.jpg"},
{name:"Vine Tomatoes", price:1.99, category:"Vegetables", img:"img/Vine-Tomato_Iconic.jpg"},
{name:"Yellow Onion", price:0.40, category:"Vegetables", img:"img/Yellow-Onion_Iconic.jpg"},
{name:"Alpro Soya Milk Original", price:2.29, category:"Dairy-free", img:"img/Alpro-Fresh-Soy-Milk_Iconic.jpg"},

{name:"Vipiteno 0.1% Low-Fat Yogurt", price:1.69, category:"Dairy", img:"img/front_it.56.200 (2).jpg"},
{name:"NestlÃ© Fitness Chocolate Bars (6-pack)", price:2.99, category:"Snacks", img:"img/front_fr.190.200.jpg"},
{name:"Conad Verso Natura Organic Chickpea Falafel", price:3.49, category:"Vegan", img:"img/front_it.3.200 (7).jpg"},
{name:"Parmareggio Butter", price:2.29, category:"Dairy", img:"img/front_it.9.200 (1).jpg"},
{name:"Mulino Bianco Fisarmoniche Biscuits", price:2.89, category:"Biscuits", img:"img/front_it.12.200.jpg"},
{name:"San Carlo Light Chips", price:1.89, category:"Snacks", img:"img/front_it.26.200.jpg"},
{name:"EstathÃ© Lemon 3-pack", price:1.69, category:"Drinks", img:"img/front_it.28.200 (2).jpg"},
{name:"Mulino Bianco Flauti Chocolate", price:2.99, category:"Bakery", img:"img/front_it.33.200 (1).jpg"},
{name:"Loacker Napolitaner Wafers", price:1.99, category:"Biscuits", img:"img/front_it.44.200.jpg"},
{name:"Pavesini 200g", price:1.99, category:"Biscuits", img:"img/Pavesini_Pavesi_200_g.jpg"},
{name:"M&M's Peanut", price:2.49, category:"Snacks", img:"img/front_it.296.200.jpg"},
{name:"Kinder Cioccolato", price:1.89, category:"Chocolate", img:"img/front_it.165.200.jpg"},




    // ---- Add filler products up to 70 ----
];

// Add placeholder items until we reach 70
while (products.length < 70) {
    products.push({
        name: "Placeholder Product " + (products.length + 1),
        price: (Math.random()*4+1).toFixed(2),
        category: "Misc",
        img: ""
    });
}





function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("show");

    setTimeout(() => {
        toast.classList.remove("show");
    }, 1500); // sparisce dopo 1.5 secondi
}



// --------------------------
// USER PROFILE VARIABLES
// --------------------------
let userID = "USER_" + Math.floor(Math.random() * 1000000);
let userAge = "";
let userGender = "";
let userNation = "";
let userOnline = "";
let userFreq = "";

// --------------------------
// START EXPERIMENT FUNCTION
// --------------------------
function startExperiment() {

    userAge = document.getElementById("ageInput").value;
    userGender = document.getElementById("genderInput").value;
    userNation = document.getElementById("nationInput").value;
    userOnline = document.getElementById("onlineInput").value;
    userFreq = document.getElementById("freqInput").value;

    if (userAge === "" || userGender === "" || userNation === "") {
        alert("Please complete all required fields.");
        return;
    }

    // Hide the start screen
    document.getElementById("startScreen").style.display = "none";

    // Reset experiment timer
    experimentStart = Date.now();

    console.log("Experiment started for:", userID);
}



// -----------------------------------------------------------------------------
// BUILD SHELF
// -----------------------------------------------------------------------------
function buildShelf() {
    const shelf = document.getElementById("shelf");
    shelf.innerHTML = "";

    // --- NUOVA GRIGLIA PERFETTA: 5 COLONNE ---
    let grid = document.createElement("div");
    grid.className = "productGrid";
    shelf.appendChild(grid);

    let hoverStart = 0;

    products.forEach((p) => {

        let slot = document.createElement("div");
        slot.className = "product";

        // --- immagine ---
        let img = document.createElement("img");
        img.src = p.img || "https://via.placeholder.com/120";

        // --- nome ---
        let name = document.createElement("div");
        name.className = "name";
        name.textContent = p.name;

        // --- prezzo ---
        let price = document.createElement("div");
        price.className = "price";
        price.textContent = "â‚¬" + p.price;

        // =====================================================
        // EVENTI MOUSEOVER (slot intero)
        // =====================================================
        slot.onmouseover = () => {
            hoverStart = Date.now();
            hoverLog.push({
                product: p.name,
                hover_ms: Date.now() - experimentStart
            });
        };

        slot.onmouseleave = () => {
            let time = Date.now() - hoverStart;
            if (time > 1500) {
                indecisionLog.push({
                    product: p.name,
                    indecision_ms: time
                });
            }
        };

        // =====================================================
        // CLICK SU TUTTO IL BOX PRODOTTO
        // =====================================================
        slot.onclick = () => {
            clickLog.push({
                product: p.name,
                price: p.price,
                category: p.category,
                click_ms: Date.now() - experimentStart
            });

            cart.push(p);
            document.getElementById("cartCount").innerText = cart.length;

            showToast(p.name + " added to cart âœ“");
        };

        slot.appendChild(img);
        slot.appendChild(name);
        slot.appendChild(price);

        grid.appendChild(slot);
    });
}


buildShelf();

// -----------------------------------------------------------------------------
// CART
// -----------------------------------------------------------------------------
function openCart() {
    document.getElementById("shelf").style.display = "none";
    document.getElementById("cartPage").style.display = "block";

    let html = "<ul>";
    cart.forEach(p => html += `<li>${p.name} â€” â‚¬${p.price}</li>`);
    html += "</ul>";

    document.getElementById("cartList").innerHTML = html;
}

function closeCart() {
    document.getElementById("cartPage").style.display = "none";
    document.getElementById("shelf").style.display = "block";
}

// -----------------------------------------------------------------------------
// CSV EXPORT
// -----------------------------------------------------------------------------
function downloadCSV() {


	let totalTime = Date.now() - experimentStart;

	let csv = "USER_ID,AGE,GENDER,NATION,ONLINE_FREQ,SHOP_FREQ,TOTAL_TIME_MS\n";
	csv += `${userID},${userAge},${userGender},${userNation},${userOnline},${userFreq},${totalTime}\n\n`;

    csv += "PRODUCT,PRICE,CATEGORY,CLICK_TIME_MS\n";
    clickLog.forEach(e => csv += `${e.product},${e.price},${e.category},${e.click_ms}\n`);

    csv += "\nHOVER_LOG\nPRODUCT,HOVER_TIME_MS\n";
    hoverLog.forEach(h => csv += `${h.product},${h.hover_ms}\n`);

    csv += "\nINDECISION_LOG\nPRODUCT,INDECISION_MS\n";
    indecisionLog.forEach(i => csv += `${i.product},${i.indecision_ms}\n`);

    const blob = new Blob([csv], { type:"text/plain" });  
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `experiment_${userID}.log`;   // <<<<<< QUI CAMBIA
    a.click();
}






/* =====================================================
   DEVELOPER SECRET START (CTRL + D)
   ===================================================== */
document.addEventListener("keydown", (e) => {
    if (e.ctrlKey && e.key.toLowerCase() === "d") {
        e.preventDefault();

        // Nascondi eventuali schermate iniziali
        if (document.getElementById("introScreen"))
            document.getElementById("introScreen").style.display = "none";
        if (document.getElementById("startScreen"))
            document.getElementById("startScreen").style.display = "none";

        // Mostra scaffale + dev tools
        buildShelf();
        document.getElementById("devPanel").style.display = "block";

        showToast("Developer Mode Enabled âœ“");
        console.log("Developer mode ON");
    }
});





/* ============================================================
   PROFILI UTENTE
============================================================ */

const profileSettings = {
    impulsivo: { picks: [8,15], hover: [100,300], indecision: 0.05, category: "ALL" },
    indeciso:  { picks: [5,10], hover: [1500,4000], indecision: 0.45, category: "ALL" },
    razionale:{ picks: [4,7], hover: [400,900], indecision: 0.10, category: "ALL" },
    veloce:   { picks: [3,6], hover: [50,150], indecision: 0.02, category: "ALL" },
    sinistro: { picks: [5,10], hover: [300,900], indecision: 0.15, bias:"left", category:"ALL"},
    destro:   { picks: [5,10], hover: [300,900], indecision: 0.15, bias:"right", category:"ALL"},
    goloso:   { picks: [6,12], hover: [300,700], indecision: 0.12, category:["Biscuits","Chocolate","Snacks"]},
    sano:     { picks: [6,12], hover: [200,700], indecision: 0.12, category:["Vegan","Fruit","Vegetables","Dairy-free"]},
    price:    { picks: [7,14], hover: [400,1200], indecision: 0.15, priceMax:2 },
    random:   { picks: [5,10], hover: [100,2000], indecision: 0.20, category:"ALL" }
};


/* ============================================================
   GENERA UNA SINGOLA SIMULAZIONE
============================================================ */

function generateSimulationForProfile(profileName) {

    let conf = profileSettings[profileName];
    let simClick = [], simHover = [], simIndecision = [], simCart = [];

    let nPicks = conf.picks[0] + Math.floor(Math.random() * (conf.picks[1] - conf.picks[0]));

    for (let i = 0; i < nPicks; i++) {

        let filtered = products;

        if (conf.category !== "ALL") {
            filtered = filtered.filter(p => conf.category.includes(p.category));
        }

        if (conf.priceMax) {
            filtered = filtered.filter(p => p.price <= conf.priceMax);
        }

        if (conf.bias === "left") {
            filtered = filtered.slice(0, filtered.length/2);
        }
        if (conf.bias === "right") {
            filtered = filtered.slice(filtered.length/2);
        }

        let p = filtered[Math.floor(Math.random()*filtered.length)];

        // click
        simClick.push({
            product:p.name,
            price:p.price,
            category:p.category,
            click_ms: Math.floor(Math.random()*8000)
        });

        // hover
        simHover.push({
            product:p.name,
            hover_ms: conf.hover[0] + Math.floor(Math.random() * (conf.hover[1]-conf.hover[0]))
        });

        // indecisioni
        if (Math.random() < conf.indecision) {
            simIndecision.push({
                product:p.name,
                indecision_ms: 1500 + Math.floor(Math.random()*3000)
            });
        }

        simCart.push(p);
    }

    return {simClick, simHover, simIndecision, simCart};
}


/* ============================================================
   ESEGUI MULTI-PROFILO
============================================================ */

function runDeveloperSim() {

    const n = parseInt(document.getElementById("simCount").value);
    const chosenProfiles = [...document.querySelectorAll(".simProfile:checked")].map(c=>c.value);

    if (chosenProfiles.length === 0) {
        alert("Select at least one profile.");
        return;
    }

    devSimulations = [];

    for (let p of chosenProfiles) {
        for (let i=0; i<n; i++) {
            let sim = generateSimulationForProfile(p);
            devSimulations.push({profile:p, ...sim});
        }
    }

    showToast(`Generated ${n} simulations Ã— ${chosenProfiles.length} profiles âœ”`);
}


/* ============================================================
   DOWNLOAD ZIP
============================================================ */
function downloadAllSim() {

    if (devSimulations.length === 0) {
        alert("No simulations to download. Run first.");
        return;
    }

    let zip = new JSZip();

    devSimulations.forEach((sim, index) => {

        let csv = "";

        csv += `PROFILE,${sim.profile}\n\n`;

        csv += "PRODUCT,PRICE,CATEGORY,CLICK_TIME_MS\n";
        sim.simClick.forEach(e => {
            csv += `${e.product},${e.price},${e.category},${e.click_ms}\n`;
        });

        csv += "\nHOVER_LOG\nPRODUCT,HOVER_TIME_MS\n";
        sim.simHover.forEach(h => {
            csv += `${h.product},${h.hover_ms}\n`;
        });

        csv += "\nINDECISION_LOG\nPRODUCT,INDECISION_MS\n";
        sim.simIndecision.forEach(i => {
            csv += `${i.product},${i.indecision_ms}\n`;
        });

        const filename = `${sim.profile}_${String(index + 1).padStart(2, "0")}.csv`;

        // **FIX IMPORTANTE**
        zip.file(filename, new Blob([csv], { type: "text/csv;charset=utf-8" }));
    });

    zip.generateAsync({ type: "blob" }).then(content => {
        let a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = "simulations.zip";
        a.click();
    });
}


function showParticipantForm() {
    document.getElementById("introScreen").style.display = "none";
    document.getElementById("startScreen").style.display = "flex";
	
}


</script>





<div id="devPanel" style="
    display:none;
    position:fixed;
    bottom:20px;
    right:20px;
    background:#111;
    color:white;
    padding:20px;
    border-radius:16px;
    width:290px;
    box-shadow:0 4px 14px rgba(0,0,0,0.3);
    z-index:3000;
">
    <h3 style="margin-top:0; font-size:18px;">Developer Tools</h3>

<label>Number of simulations per profile:</label>
<input id="simCount" type="number" min="1" max="200" value="1" 
       style="width:100%; padding:6px; border-radius:8px; border:none; margin:6px 0 12px;">

<label style="font-weight:bold;">Select profiles:</label>

<div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; font-size:14px; margin-bottom:12px;">
    <label><input type="checkbox" class="simProfile" value="impulsivo"> Impulsivo</label>
    <label><input type="checkbox" class="simProfile" value="indeciso"> Indeciso</label>
    <label><input type="checkbox" class="simProfile" value="razionale"> Razionale</label>
    <label><input type="checkbox" class="simProfile" value="veloce"> Veloce</label>
    <label><input type="checkbox" class="simProfile" value="sinistro"> Sinistro</label>
    <label><input type="checkbox" class="simProfile" value="destro"> Destro</label>
    <label><input type="checkbox" class="simProfile" value="goloso"> Goloso</label>
    <label><input type="checkbox" class="simProfile" value="sano"> Sano</label>
    <label><input type="checkbox" class="simProfile" value="price"> Price Sensitive</label>
    <label><input type="checkbox" class="simProfile" value="random"> Random</label>
</div>

<button onclick="runDeveloperSim()" style="
    width:100%; padding:10px; background:#0a84ff; color:white;
    border:none; border-radius:10px; font-size:15px; cursor:pointer;">
    â–¶ Run Simulation
</button>

<button onclick="downloadAllSim()" style="
    width:100%; padding:10px; background:#ffc400; color:black;
    border:none; border-radius:10px; font-size:15px; cursor:pointer; margin-top:10px;">
    â¬‡ Download CSV (All Sims)
</button>


</div>




</body>
</html>
